<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord Agent - Service de Réservation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #45a049;
            --primary-light: #e8f5e9;
            --secondary-color: #f5f5f5;
            --dark-color: #2c3e50;
            --light-color: #ffffff;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196F3;
            --success-color: #4CAF50;
            --border-color: #ddd;
            --text-color: #333;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }     
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        /* Header Styles */
        header {
            background-color: var(--dark-color);
            color: var(--light-color);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--light-color);
            display: flex;
            align-items: center;
            text-decoration: none;
        }
        
        .logo i {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-name {
            margin-right: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .user-name i {
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        
        .agency-badge {
            background-color: var(--primary-light);
            color: var(--primary-color);
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 1rem;
            display: flex;
            align-items: center;
        }
        
        .agency-badge i {
            margin-right: 0.5rem;
        }
        
        /* Button Styles */
        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            border: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 500;
        }
        
        .btn i {
            margin-right: 0.5rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: var(--light-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        
        .btn-outline:hover {
            background-color: var(--primary-light);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: var(--light-color);
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--light-color);
        }
        
        .btn-warning:hover {
            background-color: #e68a00;
        }
        
        .btn-info {
            background-color: var(--info-color);
            color: var(--light-color);
        }
        
        .btn-info:hover {
            background-color: #0b7dda;
        }
        
        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-online {
            background-color: var(--primary-color);
            box-shadow: 0 0 5px var(--primary-color);
        }
        
        .status-offline {
            background-color: var(--danger-color);
            box-shadow: 0 0 5px var(--danger-color);
        }
        
        /* Dashboard Layout */
        .dashboard {
            display: flex;
            margin: 1.5rem 0;
        }
        
        .sidebar {
            width: 280px;
            background-color: var(--light-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-right: 1.5rem;
            height: calc(100vh - 100px);
            position: sticky;
            top: 90px;
            overflow-y: auto;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-header i {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            color: var(--primary-color);
        }
        
        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .sidebar-menu {
            list-style-type: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }
        
        .sidebar-menu li a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: var(--text-color);
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .sidebar-menu li a i {
            margin-right: 0.5rem;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-menu li a:hover,
        .sidebar-menu li a.active {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }
        
        .main-content {
            flex: 1;
            background-color: var(--light-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            min-height: calc(100vh - 100px);
        }
        
        .section-title {
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title h2 {
            font-size: 1.5rem;
            color: var(--dark-color);
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .section-title h2 i {
            margin-right: 0.75rem;
            color: var(--primary-color);
        }
        
        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.25rem;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }
        
        .stat-icon i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .stat-info {
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Reservation Cards */
        .tabs-container {
            margin-bottom: 1.5rem;
        }
        
        .tabs {
            display: flex;
            background-color: var(--light-color);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        
        .tab {
            flex: 1;
            padding: 0.75rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab i {
            margin-right: 0.5rem;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: var(--light-color);
        }
        
        .tab-counter {
            display: inline-block;
            background-color: var(--warning-color);
            color: white;
            border-radius: 50px;
            padding: 0.2rem 0.5rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .reservations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .reservation-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
        }
        
        .reservation-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .reservation-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reservation-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .reservation-title i {
            margin-right: 0.75rem;
            color: var(--primary-color);
        }
        
        .reservation-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background-color: #fff8e1;
            color: #ff8f00;
        }
        
        .status-confirmed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-canceled {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .status-completed {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .reservation-body {
            padding: 1rem;
        }
        
        .reservation-meta {
            margin-bottom: 1rem;
        }
        
        .reservation-meta div {
            display: flex;
            margin-bottom: 0.5rem;
        }
        
        .reservation-meta i {
            width: 20px;
            margin-right: 0.75rem;
            color: #666;
        }
        
        .reservation-description {
            background-color: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }
        
        .reservation-actions {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background-color: #f8f9fa;
        }
        
        /* Activity Badge */
        .reservation-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1;
        }
        
        .badge-free {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .badge-processing {
            background-color: #e3f2fd;
            color: #1565c0;
            animation: pulse 1.5s infinite;
        }
        
        .badge-completed {
            background-color: #efebe9;
            color: #6d4c41;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        /* Profile Section */
        .profile-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .profile-header {
            background-color: var(--primary-light);
            padding: 2rem 1.5rem;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            align-items: center;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 2rem;
            font-size: 3rem;
            color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .profile-info h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
        }
        
        .profile-info p {
            margin: 0;
            color: #666;
        }
        
        .profile-content {
            padding: 1.5rem;
        }
        
        .profile-section {
            margin-bottom: 2rem;
        }
        
        .profile-section:last-child {
            margin-bottom: 0;
        }
        
        .profile-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }
        
        .profile-section-title i {
            margin-right: 0.75rem;
            color: var(--primary-color);
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .profile-stat {
            background-color: #f9f9f9;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }
        
        .profile-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .profile-stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        /* Availability Calendar Styles */
        .date-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .current-week-label {
            font-weight: 600;
            color: var(--primary-color);
        }

        .availability-calendar {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: var(--primary-light);
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-day {
            text-align: center;
            padding: 0.75rem 0.5rem;
            font-weight: 600;
            position: relative;
        }

        .calendar-day.today {
            background-color: var(--primary-color);
            color: white;
        }

        .calendar-day .day-name {
            display: block;
            font-size: 0.85rem;
            color: #666;
        }

        .calendar-day .day-date {
            display: block;
            font-size: 1rem;
            margin-top: 0.25rem;
        }

        .calendar-day.today .day-name,
        .calendar-day.today .day-date {
            color: white;
        }

        .calendar-slots {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: var(--border-color);
            padding: 1px;
        }

        .day-slots {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background-color: var(--border-color);
        }

        .time-slot {
            padding: 0.5rem;
            text-align: center;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-slot:hover {
            background-color: var(--primary-light);
        }

        .time-slot.available {
            background-color: #e8f5e9;
        }

        .time-slot.available:hover {
            background-color: #c8e6c9;
        }

        .time-slot.booked {
            background-color: #ffebee;
            cursor: default;
            color: #999;
        }

        .time-slot.booked:hover {
            background-color: #ffcdd2;
        }

        .time-slot.selected {
            background-color: var(--primary-color);
            color: white;
        }

        .time-slot.selected:hover {
            background-color: var(--primary-dark);
        }

        .time-slot.no-slots {
            background-color: #f5f5f5;
            cursor: default;
            color: #999;
            padding: 1rem;
        }

        /* Styles pour les créneaux passés */
        .time-slot.past-slot {
            background-color: #f2f2f2;
            color: #999;
            text-decoration: line-through;
            cursor: not-allowed;
        }

        .calendar-day.past-date {
            background-color: #f2f2f2;
            color: #999;
        }

        .time-slot.past-date-message {
            background-color: #f2f2f2;
            color: #999;
            font-style: italic;
            padding: 1.5rem;
            text-align: center;
        }
        
        /* Loader and Alerts */
        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 3rem;
            color: #666;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(76, 175, 80, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-reservations {
            text-align: center;
            padding: 3rem 0;
            color: #666;
        }
        
        .alert {
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .alert i {
            margin-right: 0.75rem;
            font-size: 1.2rem;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }
        
        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        
        /* Forms and Modals */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }
        
        select.form-control {
            background-color: white;
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 0;
        }
        
        .modal-dialog {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--light-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--primary-color);
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            color: white;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            background-color: #f8f9fa;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: #f0f0f0;
        }
        
        /* Utilities */
        .hidden {
            display: none !important;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mt-2 {
            margin-top: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .reservations-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }
        
        @media (max-width: 992px) {
            .dashboard {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                margin-right: 0;
                margin-bottom: 1.5rem;
                height: auto;
                position: static;
            }
            
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .stats-row,
            .profile-stats {
                grid-template-columns: 1fr;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                margin-right: 0;
                margin-bottom: 1rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-bottom: 1px solid var(--border-color);
            }
            
            .tab:last-child {
                border-bottom: none;
            }
            
            .calendar-days, 
            .calendar-slots {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .calendar-day, 
            .day-slots {
                min-height: 60px;
            }
            
            .calendar-day .day-name {
                font-size: 0.75rem;
            }
            
            .calendar-day .day-date {
                font-size: 0.9rem;
            }
            
            .date-navigation {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            
            .current-week-label {
                order: -1;
                text-align: center;
                margin-bottom: 0.5rem;
            }
        }
        
        /* Custom Animation */
        @keyframes highlightNew {
            0% { 
                background-color: rgba(76, 175, 80, 0.3);
                transform: scale(1.02);
            }
            100% { 
                background-color: white;
                transform: scale(1);
            }
        }
        
        .highlight-new {
            animation: highlightNew 2s ease-out;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <a href="index.html" class="logo">
                <i class="fas fa-calendar-check"></i>
                <span>Service de Réservation</span>
            </a>
            <div class="user-info">
                <div class="agency-badge">
                    <i class="fas fa-building"></i>
                    <span id="agencyName">Nom de l'agence</span>
                </div>
                <span class="user-name">
                    <i class="fas fa-user-circle"></i>
                    <span id="username">Utilisateur</span>
                </span>
                <span class="status-indicator status-online" id="wsStatus" title="Connecté aux notifications en temps réel"></span>
                <button id="logoutBtn" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="dashboard">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <i class="fas fa-th-large"></i>
                    <h3 class="sidebar-title">Tableau de bord</h3>
                </div>
                <ul class="sidebar-menu">
                    <li>
                        <a href="#" class="active" data-section="dashboard-section">
                            <i class="fas fa-tachometer-alt"></i> Tableau de bord
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="calendar-section">
                            <i class="fas fa-calendar-alt"></i> Calendrier
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="profile-section">
                            <i class="fas fa-user"></i> Mon profil
                        </a>
                    </li>
                    <li>
                        <a href="#" data-section="settings-section">
                            <i class="fas fa-cog"></i> Paramètres
                        </a>
                    </li>
                </ul>
            </aside>
            
            <main class="main-content">
                <!-- Dashboard Section -->
                <section id="dashboard-section">
                    <div class="section-title">
                        <h2><i class="fas fa-tachometer-alt"></i> Tableau de bord</h2>
                    </div>
                    
                    <div id="alertContainer"></div>
                    
                    <!-- Stats Cards -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="pendingCount">0</div>
                                <div class="stat-label">Réservations en attente</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="confirmedCount">0</div>
                                <div class="stat-label">Rendez-vous confirmés</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="todayCount">0</div>
                                <div class="stat-label">Rendez-vous aujourd'hui</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-info">
                                <div class="stat-value" id="completedCount">0</div>
                                <div class="stat-label">Rendez-vous complétés</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reservations Tabs -->
                    <div class="tabs-container">
                        <div class="tabs">
                            <div class="tab active" data-tab="pending-tab">
                                <i class="fas fa-clock"></i> En attente
                                <span class="tab-counter" id="pendingCounter">0</span>
                            </div>
                            <div class="tab" data-tab="confirmed-tab">
                                <i class="fas fa-calendar-check"></i> Confirmés
                                <span class="tab-counter" id="confirmedCounter">0</span>
                            </div>
                            <div class="tab" data-tab="completed-tab">
                                <i class="fas fa-check-circle"></i> Complétés
                                <span class="tab-counter" id="completedTabCounter">0</span>
                            </div>
                            <div class="tab" data-tab="canceled-tab">
                                <i class="fas fa-times-circle"></i> Annulés
                                <span class="tab-counter" id="canceledCounter">0</span>
                            </div>
                        </div>
                        
                        <!-- Pending Reservations Tab -->
                        <div class="tab-content active" id="pending-tab">
                            <div id="pendingLoader" class="loader">
                                <div class="loading-spinner"></div>
                                <p>Chargement des réservations en attente...</p>
                            </div>
                            
                            <div id="noPendingReservations" class="no-reservations hidden">
                                <p>Aucune réservation en attente pour le moment.</p>
                            </div>
                            
                            <div id="pendingReservationsGrid" class="reservations-grid">
                                <!-- Pending reservations will be added here -->
                            </div>
                        </div>
                        
                        <!-- Confirmed Reservations Tab -->
                        <div class="tab-content" id="confirmed-tab">
                            <div id="confirmedLoader" class="loader">
                                <div class="loading-spinner"></div>
                                <p>Chargement des rendez-vous confirmés...</p>
                            </div>
                            
                            <div id="noConfirmedReservations" class="no-reservations hidden">
                                <p>Aucun rendez-vous confirmé pour le moment.</p>
                            </div>
                            
                            <div id="confirmedReservationsGrid" class="reservations-grid">
                                <!-- Confirmed reservations will be added here -->
                            </div>
                        </div>
                        
                        <!-- Completed Reservations Tab -->
                        <div class="tab-content" id="completed-tab">
                            <div id="completedLoader" class="loader">
                                <div class="loading-spinner"></div>
                                <p>Chargement des rendez-vous complétés...</p>
                            </div>
                            
                            <div id="noCompletedReservations" class="no-reservations hidden">
                                <p>Aucun rendez-vous complété pour le moment.</p>
                            </div>
                            
                            <div id="completedReservationsGrid" class="reservations-grid">
                                <!-- Completed reservations will be added here -->
                            </div>
                        </div>
                        
                        <!-- Canceled Reservations Tab -->
                        <div class="tab-content" id="canceled-tab">
                            <div id="canceledLoader" class="loader">
                                <div class="loading-spinner"></div>
                                <p>Chargement des réservations annulées...</p>
                            </div>
                            
                            <div id="noCanceledReservations" class="no-reservations hidden">
                                <p>Aucune réservation annulée pour le moment.</p>
                            </div>
                            
                            <div id="canceledReservationsGrid" class="reservations-grid">
                                <!-- Canceled reservations will be added here -->
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Calendar Section -->
                <section id="calendar-section" class="hidden">
                    <div class="section-title">
                        <h2><i class="fas fa-calendar-alt"></i> Calendrier des disponibilités</h2>
                    </div>
                    
                    <!-- Message d'information sur la vue des disponibilités -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Ce calendrier montre les créneaux disponibles (vert) et réservés (rouge) pour chaque jour. Les créneaux passés sont automatiquement masqués.</span>
                    </div>
                    
                    <!-- Navigation de date -->
                    <div class="date-navigation">
                        <button type="button" class="btn btn-outline btn-sm" id="prevWeekBtn">
                            <i class="fas fa-chevron-left"></i> Semaine précédente
                        </button>
                        <span id="currentWeekLabel" class="current-week-label">Semaine du 01/01/2025</span>
                        <button type="button" class="btn btn-outline btn-sm" id="nextWeekBtn">
                            Semaine suivante <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Calendrier de disponibilité -->
                    <div class="availability-calendar">
                        <div class="calendar-days" id="calendarDays">
                            <!-- Jours de la semaine générés par JS -->
                        </div>
                        <div class="calendar-slots" id="calendarSlots">
                            <!-- Créneaux horaires générés par JS -->
                        </div>
                    </div>
                    
                    <!-- Légende du calendrier -->
                    <div class="mt-2" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center;">
                            <div style="width: 20px; height: 20px; background-color: #e8f5e9; margin-right: 5px; border-radius: 4px;"></div>
                            <span>Disponible</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="width: 20px; height: 20px; background-color: #ffebee; margin-right: 5px; border-radius: 4px;"></div>
                            <span>Réservé</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="width: 20px; height: 20px; background-color: var(--primary-color); margin-right: 5px; border-radius: 4px;"></div>
                            <span>Sélectionné</span>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="width: 20px; height: 20px; background-color: #f2f2f2; margin-right: 5px; border-radius: 4px;"></div>
                            <span>Passé</span>
                        </div>
                    </div>
                </section>
                
                <!-- Profile Section -->
                <section id="profile-section" class="hidden">
                    <div class="section-title">
                        <h2><i class="fas fa-user"></i> Mon profil</h2>
                    </div>
                    
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="profile-info">
                                <h3 id="profileUsername">Nom d'utilisateur</h3>
                                <p id="profileEmail">email@example.com</p>
                                <p id="profileAgency">Agence: <strong>Nom de l'agence</strong></p>
                            </div>
                        </div>
                        
                        <div class="profile-content">
                            <div class="profile-section">
                                <h4 class="profile-section-title">
                                    <i class="fas fa-chart-line"></i> Statistiques de performances
                                </h4>
                                
                                <div class="profile-stats">
                                    <div class="profile-stat">
                                        <div class="profile-stat-value" id="stat24hCount">0</div>
                                        <div class="profile-stat-label">Rendez-vous gérés (24h)</div>
                                    </div>
                                    
                                    <div class="profile-stat">
                                        <div class="profile-stat-value" id="statConfirmedCount">0</div>
                                        <div class="profile-stat-label">Rendez-vous confirmés</div>
                                    </div>
                                    
                                    <div class="profile-stat">
                                        <div class="profile-stat-value" id="statCompletedCount">0</div>
                                        <div class="profile-stat-label">Rendez-vous complétés</div>
                                    </div>
                                    
                                    <div class="profile-stat">
                                        <div class="profile-stat-value" id="statCanceledCount">0</div>
                                        <div class="profile-stat-label">Rendez-vous annulés</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="profile-section">
                                <h4 class="profile-section-title">
                                    <i class="fas fa-cog"></i> Paramètres du compte
                                </h4>
                                
                                <form id="profileUpdateForm">
                                    <div class="form-group">
                                        <label for="updateUsername" class="form-label">Nom d'utilisateur</label>
                                        <input type="text" id="updateUsername" class="form-control" value="">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="currentEmail" class="form-label">Email</label>
                                        <input type="email" id="currentEmail" class="form-control" value="" disabled>
                                    </div>
                                    
                                    <div class="text-right">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Enregistrer les modifications
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Settings Section -->
                <section id="settings-section" class="hidden">
                    <div class="section-title">
                        <h2><i class="fas fa-cog"></i> Paramètres</h2>
                    </div>
                    
                    <div class="profile-card">
                        <div class="profile-content">
                            <div class="profile-section">
                                <h4 class="profile-section-title">
                                    <i class="fas fa-lock"></i> Sécurité
                                </h4>
                                
                                <form id="changePasswordForm">
                                    <div class="form-group">
                                        <label for="currentPassword" class="form-label">Mot de passe actuel</label>
                                        <input type="password" id="currentPassword" class="form-control" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="newPassword" class="form-label">Nouveau mot de passe</label>
                                        <input type="password" id="newPassword" class="form-control" required minlength="8">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="confirmPassword" class="form-label">Confirmer le nouveau mot de passe</label>
                                        <input type="password" id="confirmPassword" class="form-control" required minlength="8">
                                    </div>
                                    
                                    <div class="text-right">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Changer le mot de passe
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="profile-section">
                                <h4 class="profile-section-title">
                                    <i class="fas fa-bell"></i> Notifications
                                </h4>
                                
                                <div class="form-group">
                                    <div class="form-check">
                                        <input type="checkbox" id="emailNotifications" checked>
                                        <label for="emailNotifications">
                                            Recevoir des notifications par email
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <div class="form-check">
                                        <input type="checkbox" id="browserNotifications" checked>
                                        <label for="browserNotifications">
                                            Recevoir des notifications dans le navigateur
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="text-right">
                                    <button type="button" class="btn btn-primary" id="saveNotificationSettings">
                                        <i class="fas fa-save"></i> Enregistrer les préférences
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>
    
    <!-- Modal de confirmation de réservation -->
    <div id="confirmationModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Confirmer la réservation</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="confirmationAlert" class="alert hidden"></div>
                <form id="confirmationForm">
                    <input type="hidden" id="reservationId">
                    
                    <div class="form-group">
                        <label for="messageToClient" class="form-label">Message au client (facultatif)</label>
                        <textarea id="messageToClient" class="form-control" placeholder="Informations supplémentaires pour le client..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="startDateTime" class="form-label">Date et heure de début</label>
                        <input type="datetime-local" id="startDateTime" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="endDateTime" class="form-label">Date et heure de fin</label>
                        <input type="datetime-local" id="endDateTime" class="form-control" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline cancel-modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmReservationBtn">Confirmer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de complétion de réservation -->
    <div id="completeModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Compléter le rendez-vous</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="completeAlert" class="alert hidden"></div>
                <form id="completeForm">
                    <input type="hidden" id="completeReservationId">
                    
                    <div class="form-group">
                        <label for="completionNotes" class="form-label">Notes de complétion (facultatif)</label>
                        <textarea id="completionNotes" class="form-control" placeholder="Notes sur le rendez-vous..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline cancel-modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="completeReservationBtn">Marquer comme complété</button>
            </div>
        </div>
    </div>
    
    <!-- Modal d'annulation de réservation -->
    <div id="cancelModal" class="modal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Annuler la réservation</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cancelAlert" class="alert hidden"></div>
                <p>Êtes-vous sûr de vouloir annuler cette réservation ? Cette action est irréversible.</p>
                <form id="cancelForm">
                    <input type="hidden" id="cancelReservationId">
                    
                    <div class="form-group">
                        <label for="cancellationReason" class="form-label">Raison de l'annulation (facultatif)</label>
                        <textarea id="cancellationReason" class="form-control" placeholder="Raison de l'annulation..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline cancel-modal">Retour</button>
                <button type="button" class="btn btn-danger" id="cancelReservationBtn">Confirmer l'annulation</button>
            </div>
        </div>
    </div>

    <script>
        // Base URL pour l'API
        const API_BASE_URL = 'http://localhost:8082';
        
        // Variables globales pour stocker les données
        let userData = null;
        let agencyData = null;
        let allReservations = {
            pending: [],
            confirmed: [],
            completed: [],
            canceled: []
        };
        
        // Connecter au WebSocket pour les mises à jour en temps réel
        function connectWebSocket() {
            // Charger les bibliothèques SockJS et STOMP
            const sockjs = document.createElement('script');
            sockjs.src = 'https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js';
            sockjs.async = true;
            
            const stomp = document.createElement('script');
            stomp.src = 'https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js';
            stomp.async = true;
            
            document.head.appendChild(sockjs);
            document.head.appendChild(stomp);
            
            // Après le chargement des scripts
            stomp.onload = function() {
                console.log('Initialisation de la connexion WebSocket...');
                const socket = new SockJS(`${API_BASE_URL}/reservation-websocket`);
                stompClient = Stomp.over(socket);
                
                // Configuration pour éviter les logs trop verbeux
                stompClient.debug = null;
                
                stompClient.connect({}, function(frame) {
                    console.log('Connected to WebSocket');
                    wsStatus.className = 'status-indicator status-online';
                    
                    // S'abonner aux mises à jour des réservations
                    stompClient.subscribe('/topic/reservations', function(message) {
                        console.log('Message reçu sur /topic/reservations');
                        try {
                            const reservationsData = JSON.parse(message.body);
                            
                            // Si c'est un tableau, c'est une liste complète de réservations
                            if (Array.isArray(reservationsData)) {
                                console.log('Liste de réservations reçue:', reservationsData.length);
                                // Mettre à jour la liste des réservations en attente
                                allReservations.pending = reservationsData;
                                
                                // Mettre à jour l'interface
                                renderReservations(allReservations.pending, pendingReservationsGrid, 'pending');
                                updateCounters();
                                
                                // Masquer ou afficher le message "pas de réservations"
                                if (allReservations.pending.length === 0) {
                                    noPendingReservations.classList.remove('hidden');
                                } else {
                                    noPendingReservations.classList.add('hidden');
                                }
                            } 
                            // Sinon c'est une seule réservation nouvelle
                            else {
                                const reservation = reservationsData;
                                console.log('Nouvelle réservation reçue:', reservation);
                                if (reservation.status === 'PENDING') {
                                    // Ajouter à la liste des réservations en attente
                                    allReservations.pending.unshift(reservation);
                                    
                                    // Mettre à jour l'interface
                                    renderReservations(allReservations.pending, pendingReservationsGrid, 'pending');
                                    
                                    // Mettre à jour les compteurs
                                    updateCounters();
                                    
                                    // Masquer le message "pas de réservations"
                                    noPendingReservations.classList.add('hidden');
                                    
                                    // Afficher une notification
                                    showAlert('Nouvelle réservation reçue !', 'info');
                                    
                                    // Animer la nouvelle réservation
                                    const card = document.getElementById(`reservation-${reservation.id}`);
                                    if (card) {
                                        card.classList.add('highlight-new');
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('Erreur de traitement des données WebSocket:', e);
                        }
                    });
                    
                    // S'abonner aux mises à jour de réservations spécifiques
                    stompClient.subscribe('/topic/reservation-updated', function(message) {
                        console.log('Message reçu sur /topic/reservation-updated');
                        try {
                            const updatedReservation = JSON.parse(message.body);
                            console.log('Réservation mise à jour:', updatedReservation);
                            
                            // Traiter l'événement en fonction du statut de la réservation
                            if (updatedReservation.status === 'CONFIRMED') {
                                // Supprimer de la liste en attente
                                allReservations.pending = allReservations.pending.filter(r => r.id !== updatedReservation.id);
                                
                                // Ajouter à la liste des confirmées
                                allReservations.confirmed.unshift(updatedReservation);
                                
                                // Mettre à jour l'interface
                                renderReservations(allReservations.pending, pendingReservationsGrid, 'pending');
                                renderReservations(allReservations.confirmed, confirmedReservationsGrid, 'confirmed');
                                
                                // Mettre à jour les compteurs
                                updateCounters();
                                
                                // Mettre à jour le calendrier de disponibilité
                                if (currentSection === 'calendar-section') {
                                    availabilityCalendar.refreshAvailability();
                                }
                                
                                // Afficher une notification si nous ne sommes pas l'initiateur
                                if (updatedReservation.updatedBy !== userData.email) {
                                    showAlert('Un rendez-vous a été confirmé par un autre agent', 'info');
                                }
                            } 
                            else if (updatedReservation.status === 'COMPLETED') {
                                // Supprimer de la liste des confirmées
                                allReservations.confirmed = allReservations.confirmed.filter(r => r.id !== updatedReservation.id);
                                
                                // Ajouter à la liste des complétées
                                allReservations.completed.unshift(updatedReservation);
                                
                                // Mettre à jour l'interface
                                renderReservations(allReservations.confirmed, confirmedReservationsGrid, 'confirmed');
                                renderReservations(allReservations.completed, completedReservationsGrid, 'completed');
                                
                                // Mettre à jour les compteurs
                                updateCounters();
                                
                                // Mettre à jour le calendrier de disponibilité
                                if (currentSection === 'calendar-section') {
                                    availabilityCalendar.refreshAvailability();
                                }
                                
                                // Afficher une notification si nous ne sommes pas l'initiateur
                                if (updatedReservation.updatedBy !== userData.email) {
                                    showAlert('Un rendez-vous a été marqué comme complété par un autre agent', 'info');
                                }
                            } 
                            else if (updatedReservation.status === 'CANCELED') {
                                // Supprimer de la liste appropriée (en attente ou confirmée)
                                allReservations.pending = allReservations.pending.filter(r => r.id !== updatedReservation.id);
                                allReservations.confirmed = allReservations.confirmed.filter(r => r.id !== updatedReservation.id);
                                
                                // Ajouter à la liste des annulées
                                allReservations.canceled.unshift(updatedReservation);
                                
                                // Mettre à jour l'interface
                                renderReservations(allReservations.pending, pendingReservationsGrid, 'pending');
                                renderReservations(allReservations.confirmed, confirmedReservationsGrid, 'confirmed');
                                renderReservations(allReservations.canceled, canceledReservationsGrid, 'canceled');
                                
                                // Mettre à jour les compteurs
                                updateCounters();
                                
                                // Mettre à jour le calendrier de disponibilité
                                if (currentSection === 'calendar-section') {
                                    availabilityCalendar.refreshAvailability();
                                }
                                
                                // Afficher une notification si nous ne sommes pas l'initiateur
                                if (updatedReservation.updatedBy !== userData.email) {
                                    showAlert('Une réservation a été annulée par un autre agent', 'info');
                                }
                            }
                        } catch (e) {
                            console.error('Erreur de traitement des données WebSocket:', e);
                        }
                    });
                    
                    // S'abonner aux mises à jour de disponibilité
                    if (agencyData && agencyData.agencyId) {
                        stompClient.subscribe(`/topic/availability/${agencyData.agencyId}`, function(message) {
                            console.log(`Message reçu sur /topic/availability/${agencyData.agencyId}`);
                            try {
                                const updatedAvailability = JSON.parse(message.body);
                                
                                // Si on est sur la page de calendrier, actualiser les disponibilités
                                if (currentSection === 'calendar-section') {
                                    availabilityCalendar.refreshAvailability();
                                }
                            } catch (e) {
                                console.error('Erreur de traitement des données WebSocket pour disponibilité:', e);
                            }
                        });
                    }
                    
                    // Demander les réservations en attente
                    stompClient.send('/app/fetch-reservations', {}, {});
                }, function(error) {
                    console.error('Erreur de connexion WebSocket:', error);
                    wsStatus.className = 'status-indicator status-offline';
                    
                    // Tenter de reconnecter après 10 secondes
                    setTimeout(connectWebSocket, 10000);
                });
            };
        }
        
        // Initialiser les écouteurs d'événements
        function initEventListeners() {
            // Navigation entre les sections
            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Retirer la classe active de tous les liens
                    menuItems.forEach(menuItem => menuItem.classList.remove('active'));
                    
                    // Ajouter la classe active au lien cliqué
                    this.classList.add('active');
                    
                    // Afficher la section correspondante
                    const sectionId = this.getAttribute('data-section');
                    currentSection = sectionId;
                    
                    sections.forEach(section => section.classList.add('hidden'));
                    document.getElementById(sectionId).classList.remove('hidden');
                    
                    // Si on passe à la section calendrier, rafraîchir les disponibilités
                    if (sectionId === 'calendar-section') {
                        availabilityCalendar.refreshAvailability();
                    }
                });
            });
            
            // Navigation entre les onglets
            tabButtons.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Retirer la classe active de tous les onglets
                    tabButtons.forEach(tabButton => tabButton.classList.remove('active'));
                    
                    // Ajouter la classe active à l'onglet cliqué
                    this.classList.add('active');
                    
                    // Afficher le contenu correspondant
                    const tabId = this.getAttribute('data-tab');
                    
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Événements du calendrier de disponibilité
            prevWeekBtn.addEventListener('click', function() {
                availabilityCalendar.navigateWeek(-7);
            });
            
            nextWeekBtn.addEventListener('click', function() {
                availabilityCalendar.navigateWeek(7);
            });
            
            // Boutons des modals
            confirmReservationBtn.addEventListener('click', confirmReservation);
            completeReservationBtn.addEventListener('click', completeReservation);
            cancelReservationBtn.addEventListener('click', cancelReservation);
            
            // Fermer les modals
            document.querySelectorAll('.close-modal, .cancel-modal').forEach(button => {
                button.addEventListener('click', function() {
                    // Fermer tous les modals
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // Cliquer en dehors des modals pour les fermer
            window.addEventListener('click', function(event) {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // Formulaire de mise à jour du profil
            profileUpdateForm.addEventListener('submit', function(e) {
                e.preventDefault();
                updateProfile();
            });
            
            // Formulaire de changement de mot de passe
            changePasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                changePassword();
            });
            
            // Bouton de sauvegarde des préférences de notification
            saveNotificationSettings.addEventListener('click', function() {
                // Simuler une sauvegarde
                showAlert('Préférences de notification enregistrées', 'success');
            });
            
            // Bouton de déconnexion
            logoutBtn.addEventListener('click', logout);
        }
        
        // Mettre à jour le profil
        async function updateProfile() {
            const newUsername = updateUsername.value.trim();
            
            if (!newUsername) {
                showAlert('Le nom d\'utilisateur ne peut pas être vide', 'warning');
                return;
            }
            
            try {
                console.log(`Mise à jour du nom d'utilisateur: ${newUsername}`);
                
                const response = await fetch(`${API_BASE_URL}/api/user/update-username`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: newUsername
                    }),
                    credentials: 'include'
                });
                
                console.log('Statut de la réponse:', response.status);
                
                const data = await response.json();
                console.log('Données de réponse:', data);
                
                if (response.ok) {
                    // Mettre à jour les données utilisateur
                    userData.username = newUsername;
                    
                    // Mettre à jour l'interface
                    usernameElement.textContent = newUsername;
                    profileUsername.textContent = newUsername;
                    
                    showAlert('Profil mis à jour avec succès', 'success');
                } else {
                    showAlert(data.message || 'Erreur lors de la mise à jour du profil', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors de la mise à jour du profil:', error);
                showAlert('Erreur de connexion au serveur', 'danger');
            }
        }
        
        // Changer le mot de passe
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Vérifier que les mots de passe correspondent
            if (newPassword !== confirmPassword) {
                showAlert('Les mots de passe ne correspondent pas', 'warning');
                return;
            }
            
            try {
                console.log('Tentative de changement de mot de passe');
                
                const response = await fetch(`${API_BASE_URL}/api/user/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    }),
                    credentials: 'include'
                });
                
                console.log('Statut de la réponse:', response.status);
                
                const data = await response.json();
                console.log('Données de réponse:', data);
                
                if (response.ok) {
                    // Réinitialiser le formulaire
                    changePasswordForm.reset();
                    
                    showAlert('Mot de passe changé avec succès', 'success');
                } else {
                    showAlert(data.message || 'Erreur lors du changement de mot de passe', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors du changement de mot de passe:', error);
                showAlert('Erreur de connexion au serveur', 'danger');
            }
        }
        
        // Afficher une alerte dans le conteneur principal
        function showAlert(message, type) {
            console.log(`Alerte: ${message} (type: ${type})`);
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            // Ajouter une icône en fonction du type
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                case 'danger':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'info':
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
            }
            
            alertDiv.innerHTML = `${icon} ${message}`;
            
            // Ajouter l'alerte au conteneur
            alertContainer.appendChild(alertDiv);
            
            // Faire disparaître l'alerte après 5 secondes
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.style.transition = 'opacity 0.5s';
                
                // Supprimer l'alerte après la transition
                setTimeout(() => {
                    alertDiv.remove();
                }, 500);
            }, 5000);
        }
        
        // Afficher une alerte dans un modal
        function showModalAlert(container, message, type) {
            container.className = `alert alert-${type}`;
            
            // Ajouter une icône en fonction du type
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                case 'danger':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    break;
                case 'info':
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
            }
            
            container.innerHTML = `${icon} ${message}`;
            container.classList.remove('hidden');
            
            // Faire disparaître l'alerte après 5 secondes pour les alertes non-erreur
            if (type !== 'danger') {
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 5000);
            }
        }
        
        // Déconnexion
        async function logout() {
            try {
                // Fermer la connexion WebSocket
                if (stompClient && stompClient.connected) {
                    stompClient.disconnect();
                }
                
                const response = await fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                // Rediriger vers la page de connexion
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Erreur lors de la déconnexion:', error);
                // Rediriger quand même vers la page de connexion
                window.location.href = 'auth.html';
            }
        }
        
        // Vérification de la session
        async function checkSession() {
            try {
                console.log('Vérification de la session...');
                
                const response = await fetch(`${API_BASE_URL}/auth/check-session`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                console.log('Statut de la réponse de session:', response.status);
                
                const data = await response.json();
                console.log('Réponse de la vérification de session:', data);
                
                if (response.ok && data.success) {
                    // Extraire les informations de l'utilisateur
                    const parts = data.message.split('|');
                    const email = parts[0];
                    const role = parts[1];
                    const username = parts.length > 2 ? parts[2] : email.split('@')[0];
                    
                    console.log(`Rôle de l'utilisateur: ${role}`);
                    
                    // Vérifier si l'utilisateur a le rôle AGENT
                    if (!role.includes('ROLE_AGENT')) {
                        console.warn('Utilisateur n\'a pas le rôle AGENT');
                        // Rediriger vers la page appropriée
                        if (role.includes('ROLE_ADMIN')) {
                            window.location.href = 'admin-dashboard.html';
                        } else {
                            window.location.href = 'user-dashboard.html';
                        }
                        return;
                    }
                    
                    // Stocker les données utilisateur
                    userData = {
                        email: email,
                        role: role,
                        username: username
                    };
                    
                    console.log('Données utilisateur:', userData);
                    
                    // Afficher les informations de l'utilisateur
                    usernameElement.textContent = username;
                    profileUsername.textContent = username;
                    profileEmail.textContent = email;
                    updateUsername.value = username;
                    currentEmail.value = email;
                    
                    // Charger les informations de l'agence
                    await loadAgentAgency();
                    
                    // Charger les réservations
                    await loadAllReservations();
                    
                    // Charger les statistiques
                    loadAgentStats();
                    
                    // Initialiser le calendrier de disponibilité
                    availabilityCalendar.initialize();
                    
                    // Connecter au WebSocket pour les mises à jour en temps réel
                    connectWebSocket();
                } else {
                    console.error('Session invalide, redirection vers la page de connexion');
                    // Rediriger vers la page de connexion
                    window.location.href = 'auth.html';
                }
            } catch (error) {
                console.error('Erreur lors de la vérification de la session:', error);
                // Rediriger vers la page de connexion
                window.location.href = 'auth.html';
            }
        }
        
        let agentStats = {
            last24Hours: 0,
            confirmed: 0,
            completed: 0,
            canceled: 0
        };
        
        let stompClient = null;
        let currentSection = 'dashboard-section';
        let calendarEvents = [];
        let currentReservationId = null;
        
        // DOM Elements
        const usernameElement = document.getElementById('username');
        const agencyNameElement = document.getElementById('agencyName');
        const menuItems = document.querySelectorAll('.sidebar-menu a');
        const sections = document.querySelectorAll('main section');
        const tabButtons = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const logoutBtn = document.getElementById('logoutBtn');
        const wsStatus = document.getElementById('wsStatus');
        
        // Stats counters
        const pendingCount = document.getElementById('pendingCount');
        const confirmedCount = document.getElementById('confirmedCount');
        const todayCount = document.getElementById('todayCount');
        const completedCount = document.getElementById('completedCount');
        
        // Tab counters
        const pendingCounter = document.getElementById('pendingCounter');
        const confirmedCounter = document.getElementById('confirmedCounter');
        const completedTabCounter = document.getElementById('completedTabCounter');
        const canceledCounter = document.getElementById('canceledCounter');
        
        // Profile stats
        const stat24hCount = document.getElementById('stat24hCount');
        const statConfirmedCount = document.getElementById('statConfirmedCount');
        const statCompletedCount = document.getElementById('statCompletedCount');
        const statCanceledCount = document.getElementById('statCanceledCount');
        
        // Loaders and grids
        const pendingLoader = document.getElementById('pendingLoader');
        const confirmedLoader = document.getElementById('confirmedLoader');
        const completedLoader = document.getElementById('completedLoader');
        const canceledLoader = document.getElementById('canceledLoader');
        const pendingReservationsGrid = document.getElementById('pendingReservationsGrid');
        const confirmedReservationsGrid = document.getElementById('confirmedReservationsGrid');
        const completedReservationsGrid = document.getElementById('completedReservationsGrid');
        const canceledReservationsGrid = document.getElementById('canceledReservationsGrid');
        
        // No reservations messages
        const noPendingReservations = document.getElementById('noPendingReservations');
        const noConfirmedReservations = document.getElementById('noConfirmedReservations');
        const noCompletedReservations = document.getElementById('noCompletedReservations');
        const noCanceledReservations = document.getElementById('noCanceledReservations');
        
        // Alerts
        const alertContainer = document.getElementById('alertContainer');
        const confirmationAlert = document.getElementById('confirmationAlert');
        const completeAlert = document.getElementById('completeAlert');
        const cancelAlert = document.getElementById('cancelAlert');
        
        // Modals
        const confirmationModal = document.getElementById('confirmationModal');
        const completeModal = document.getElementById('completeModal');
        const cancelModal = document.getElementById('cancelModal');
        
        // Modal forms
        const confirmationForm = document.getElementById('confirmationForm');
        const completeForm = document.getElementById('completeForm');
        const cancelForm = document.getElementById('cancelForm');
        
        // Modal buttons
        const confirmReservationBtn = document.getElementById('confirmReservationBtn');
        const completeReservationBtn = document.getElementById('completeReservationBtn');
        const cancelReservationBtn = document.getElementById('cancelReservationBtn');
        
        // Calendar elements
        const calendarDays = document.getElementById('calendarDays');
        const calendarSlots = document.getElementById('calendarSlots');
        const currentWeekLabel = document.getElementById('currentWeekLabel');
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        
        // Profile elements
        const profileUsername = document.getElementById('profileUsername');
        const profileEmail = document.getElementById('profileEmail');
        const profileAgency = document.getElementById('profileAgency');
        const updateUsername = document.getElementById('updateUsername');
        const currentEmail = document.getElementById('currentEmail');
        const profileUpdateForm = document.getElementById('profileUpdateForm');
        
        // Settings elements
        const changePasswordForm = document.getElementById('changePasswordForm');
        const saveNotificationSettings = document.getElementById('saveNotificationSettings');
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier la session et initialiser
            checkSession();
            
            // Initialiser les écouteurs d'événements
            initEventListeners();
        });
        
        // Charger les informations de l'agence de l'agent
        async function loadAgentAgency() {
            try {
                console.log('Chargement des informations de l\'agence de l\'agent');
                
                const response = await fetch(`${API_BASE_URL}/api/agent/info`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                console.log('Statut de la réponse:', response.status);
                
                if (response.ok) {
                    agencyData = await response.json();
                    console.log('Informations de l\'agence:', agencyData);
                    
                    // Afficher le nom de l'agence
                    if (agencyData && agencyData.agencyName) {
                        agencyNameElement.textContent = agencyData.agencyName;
                        profileAgency.innerHTML = 'Agence: <strong>' + agencyData.agencyName + '</strong>';
                    } else {
                        agencyNameElement.textContent = 'Aucune agence';
                        profileAgency.innerHTML = 'Agence: <strong>Non assignée</strong>';
                    }
                } else {
                    console.error('Erreur lors du chargement des informations de l\'agence');
                    agencyNameElement.textContent = 'Erreur de chargement';
                }
            } catch (error) {
                console.error('Erreur lors du chargement des informations de l\'agence:', error);
                agencyNameElement.textContent = 'Erreur de connexion';
            }
        }
        
        // Charger toutes les réservations
        async function loadAllReservations() {
            await Promise.all([
                loadPendingReservations(),
                loadConfirmedReservations(),
                loadCompletedReservations(),
                loadCanceledReservations()
            ]);
            
            // Mettre à jour les compteurs
            updateCounters();
        }
        
        // Charger les réservations en attente
        async function loadPendingReservations() {
            pendingLoader.classList.remove('hidden');
            noPendingReservations.classList.add('hidden');
            pendingReservationsGrid.innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/agent/reservations/pending`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    allReservations.pending = await response.json();
                    
                    if (allReservations.pending.length === 0) {
                        noPendingReservations.classList.remove('hidden');
                    } else {
                        renderReservations(allReservations.pending, pendingReservationsGrid, 'pending');
                    }
                } else {
                    showAlert('Erreur lors du chargement des réservations en attente', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des réservations en attente:', error);
                showAlert('Erreur de connexion au serveur', 'danger');
            } finally {
                pendingLoader.classList.add('hidden');
            }
        }
        
        // Charger les réservations confirmées
        async function loadConfirmedReservations() {
            confirmedLoader.classList.remove('hidden');
            noConfirmedReservations.classList.add('hidden');
            confirmedReservationsGrid.innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/agent/reservations/confirmed`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    allReservations.confirmed = await response.json();
                    
                    if (allReservations.confirmed.length === 0) {
                        noConfirmedReservations.classList.remove('hidden');
                    } else {
                        renderReservations(allReservations.confirmed, confirmedReservationsGrid, 'confirmed');
                    }
                } else {
                    showAlert('Erreur lors du chargement des réservations confirmées', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des réservations confirmées:', error);
                showAlert('Erreur de connexion au serveur', 'danger');
            } finally {
                confirmedLoader.classList.add('hidden');
            }
        }
        
        // Charger les réservations complétées
        async function loadCompletedReservations() {
            completedLoader.classList.remove('hidden');
            noCompletedReservations.classList.add('hidden');
            completedReservationsGrid.innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/agent/reservations/completed`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    allReservations.completed = await response.json();
                    
                    if (allReservations.completed.length === 0) {
                        noCompletedReservations.classList.remove('hidden');
                    } else {
                        renderReservations(allReservations.completed, completedReservationsGrid, 'completed');
                    }
                } else {
                    showAlert('Erreur lors du chargement des réservations complétées', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des réservations complétées:', error);
                showAlert('Erreur de connexion au serveur', 'danger');
            } finally {
                completedLoader.classList.add('hidden');
            }
        }
        
        // Charger les réservations annulées
        async function loadCanceledReservations() {
            canceledLoader.classList.remove('hidden');
            noCanceledReservations.classList.add('hidden');
            canceledReservationsGrid.innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/agent/reservations/canceled`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    allReservations.canceled = await response.json();
                    
                    if (allReservations.canceled.length === 0) {
                        noCanceledReservations.classList.remove('hidden');
                    } else {
                        renderReservations(allReservations.canceled, canceledReservationsGrid, 'canceled');
                    }
                } else {
                    showAlert('Erreur lors du chargement des réservations annulées', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des réservations annulées:', error);
                showAlert('Erreur de connexion au serveur', 'danger');
            } finally {
                canceledLoader.classList.add('hidden');
            }
        }
        
        // Charger les statistiques de l'agent
        async function loadAgentStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/agent/stats`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    
                    // Mettre à jour les statistiques globales
                    agentStats = {
                        last24Hours: stats.last24Hours || 0,
                        confirmed: stats.totalConfirmed || 0,
                        completed: stats.totalCompleted || 0,
                        canceled: stats.totalCanceled || 0
                    };
                    
                    // Mettre à jour l'interface
                    stat24hCount.textContent = agentStats.last24Hours;
                    statConfirmedCount.textContent = agentStats.confirmed;
                    statCompletedCount.textContent = agentStats.completed;
                    statCanceledCount.textContent = agentStats.canceled;
                } else {
                    console.error('Erreur lors du chargement des statistiques');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des statistiques:', error);
            }
        }
        
        // Afficher les réservations dans la grille
        function renderReservations(reservations, gridElement, type) {
            gridElement.innerHTML = '';
            
            reservations.forEach(reservation => {
                // Créer la carte
                const card = document.createElement('div');
                card.className = 'reservation-card';
                card.id = `reservation-${reservation.id}`;
                
                // Déterminer le statut et l'icône
                let statusClass, statusText, statusIcon;
                switch (reservation.status) {
                    case 'PENDING':
                        statusClass = 'status-pending';
                        statusText = 'En attente';
                        statusIcon = 'clock';
                        break;
                    case 'CONFIRMED':
                        statusClass = 'status-confirmed';
                        statusText = 'Confirmé';
                        statusIcon = 'calendar-check';
                        break;
                    case 'COMPLETED':
                        statusClass = 'status-completed';
                        statusText = 'Complété';
                        statusIcon = 'check-circle';
                        break;
                    case 'CANCELED':
                        statusClass = 'status-canceled';
                        statusText = 'Annulé';
                        statusIcon = 'times-circle';
                        break;
                    default:
                        statusClass = '';
                        statusText = reservation.status;
                        statusIcon = 'question-circle';
                }
                
                // Ajouter le badge d'activité (simulé ici)
                const activityBadge = document.createElement('div');
                activityBadge.className = 'reservation-badge badge-free';
                activityBadge.textContent = 'Disponible';
                card.appendChild(activityBadge);
                
                // Formater les dates
                const createdDate = new Date(reservation.createdAt).toLocaleString('fr-FR');
                let startDate = '';
                let endDate = '';
                
                if (reservation.startDateTime) {
                    startDate = new Date(reservation.startDateTime).toLocaleString('fr-FR');
                }
                
                if (reservation.endDateTime) {
                    endDate = new Date(reservation.endDateTime).toLocaleString('fr-FR');
                }
                
                // Méthode robuste pour obtenir le nom du client
                const clientName = reservation.user.displayName || 
                          reservation.user.username || 
                          (reservation.user.email ? reservation.user.email.split('@')[0] : 'Client');
                
                // Construire la structure HTML de la carte
                let cardHTML = `
                    <div class="reservation-header">
                        <div class="reservation-title">
                            <i class="fas fa-${statusIcon}"></i>
                            ${reservation.service}
                        </div>
                        <span class="reservation-status ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="reservation-body">
                        <div class="reservation-meta">
                            <div>
                                <i class="fas fa-user"></i>
                                <span>${clientName}</span>
                            </div>
                            <div>
                                <i class="fas fa-envelope"></i>
                                <span>${reservation.user.email}</span>
                            </div>
                            <div>
                                <i class="fas fa-clock"></i>
                                <span>Créée le: ${createdDate}</span>
                            </div>
                `;
                
                if (startDate) {
                    cardHTML += `
                            <div>
                                <i class="fas fa-calendar-alt"></i>
                                <span>Début: ${startDate}</span>
                            </div>
                    `;
                }
                
                if (endDate) {
                    cardHTML += `
                            <div>
                                <i class="fas fa-calendar-alt"></i>
                                <span>Fin: ${endDate}</span>
                            </div>
                    `;
                }
                
                if (reservation.preferredDate && reservation.status === 'PENDING') {
                    // Format the preferred date
                    let displayDate = reservation.preferredDate;
                    if (displayDate.includes('T')) {
                        const date = new Date(displayDate);
                        displayDate = date.toLocaleDateString('fr-FR') + ' à ' + 
                                    date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
                    }
                    
                    cardHTML += `
                            <div>
                                <i class="fas fa-calendar-day"></i>
                                <span>Date souhaitée: ${displayDate}</span>
                            </div>
                    `;
                }
                
                cardHTML += `
                        </div>
                        
                        <div class="reservation-description">
                            ${reservation.description}
                        </div>
                    </div>
                `;
                
                // Ajouter les actions en fonction du type
                if (type === 'pending') {
                    cardHTML += `
                        <div class="reservation-actions">
                            <button class="btn btn-warning cancel-btn" data-id="${reservation.id}">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                            <button class="btn btn-primary confirm-btn" data-id="${reservation.id}">
                                <i class="fas fa-check"></i> Confirmer
                            </button>
                        </div>
                    `;
                } else if (type === 'confirmed') {
                    cardHTML += `
                        <div class="reservation-actions">
                            <button class="btn btn-warning cancel-btn" data-id="${reservation.id}">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                            <button class="btn btn-primary complete-btn" data-id="${reservation.id}">
                                <i class="fas fa-check-double"></i> Compléter
                            </button>
                        </div>
                    `;
                } else if (type === 'completed' || type === 'canceled') {
                    // Pas d'actions pour les réservations complétées ou annulées
                    cardHTML += `
                        <div class="reservation-actions">
                            <span class="text-muted">Aucune action disponible</span>
                        </div>
                    `;
                }
                
                card.innerHTML = cardHTML;
                gridElement.appendChild(card);
                
                // Ajouter les écouteurs d'événements pour les boutons
                if (type === 'pending') {
                    const confirmBtn = card.querySelector('.confirm-btn');
                    const cancelBtn = card.querySelector('.cancel-btn');
                    
                    confirmBtn.addEventListener('click', function() {
                        openConfirmationModal(reservation);
                    });
                    
                    cancelBtn.addEventListener('click', function() {
                        openCancelModal(reservation);
                    });
                } else if (type === 'confirmed') {
                    const completeBtn = card.querySelector('.complete-btn');
                    const cancelBtn = card.querySelector('.cancel-btn');
                    
                    completeBtn.addEventListener('click', function() {
                        openCompleteModal(reservation);
                    });
                    
                    cancelBtn.addEventListener('click', function() {
                        openCancelModal(reservation);
                    });
                }
            });
        }
        
        // Mettre à jour les compteurs
        function updateCounters() {
            // Compteurs de statistiques
            pendingCount.textContent = allReservations.pending.length;
            confirmedCount.textContent = allReservations.confirmed.length;
            completedCount.textContent = allReservations.completed.length;
            
            // Compteurs d'onglets
            pendingCounter.textContent = allReservations.pending.length;
            confirmedCounter.textContent = allReservations.confirmed.length;
            completedTabCounter.textContent = allReservations.completed.length;
            canceledCounter.textContent = allReservations.canceled.length;
            
            // Compter les rendez-vous d'aujourd'hui
            const today = new Date().setHours(0, 0, 0, 0);
            const todayReservations = allReservations.confirmed.filter(reservation => {
                if (!reservation.startDateTime) return false;
                const reservationDate = new Date(reservation.startDateTime).setHours(0, 0, 0, 0);
                return reservationDate === today;
            });
            
            todayCount.textContent = todayReservations.length;
        }
        
        // Ouvrir le modal de confirmation
        function openConfirmationModal(reservation) {
            currentReservationId = reservation.id;
            document.getElementById('reservationId').value = reservation.id;
            
            // Réinitialiser le formulaire
            confirmationForm.reset();
            confirmationAlert.classList.add('hidden');
            
            // Pré-remplir les dates si une date préférée est spécifiée
            if (reservation.preferredDate) {
                try {
                    const preferredDate = new Date(reservation.preferredDate);
                    
                    // Formater pour le champ datetime-local
                    const startDateValue = preferredDate.toISOString().slice(0, 16);
                    document.getElementById('startDateTime').value = startDateValue;
                    
                    // Définir une heure de fin par défaut (1 heure après)
                    const endDate = new Date(preferredDate);
                    endDate.setHours(endDate.getHours() + 1);
                    const endDateValue = endDate.toISOString().slice(0, 16);
                    document.getElementById('endDateTime').value = endDateValue;
                } catch (e) {
                    console.error('Erreur lors du parsing de la date préférée:', e);
                }
            } else {
                // Si pas de date préférée, utiliser la date actuelle + 1 jour
                const now = new Date();
                now.setDate(now.getDate() + 1);
                now.setHours(9, 0, 0, 0); // 9h00 par défaut
                
                const startDateValue = now.toISOString().slice(0, 16);
                document.getElementById('startDateTime').value = startDateValue;
                
                // Fin: 1 heure après
                const endDate = new Date(now);
                endDate.setHours(endDate.getHours() + 1);
                const endDateValue = endDate.toISOString().slice(0, 16);
                document.getElementById('endDateTime').value = endDateValue;
            }
            
            // Afficher le modal
            confirmationModal.style.display = 'block';
        }
        
        // Ouvrir le modal de complétion
        function openCompleteModal(reservation) {
            currentReservationId = reservation.id;
            document.getElementById('completeReservationId').value = reservation.id;
            
            // Réinitialiser le formulaire
            completeForm.reset();
            completeAlert.classList.add('hidden');
            
            // Afficher le modal
            completeModal.style.display = 'block';
        }
        
        // Ouvrir le modal d'annulation
        function openCancelModal(reservation) {
            currentReservationId = reservation.id;
            document.getElementById('cancelReservationId').value = reservation.id;
            
            // Réinitialiser le formulaire
            cancelForm.reset();
            cancelAlert.classList.add('hidden');
            
            // Afficher le modal
            cancelModal.style.display = 'block';
        }
        
        // Confirmer une réservation
        async function confirmReservation() {
            const reservationId = currentReservationId;
            const startDateTime = document.getElementById('startDateTime').value;
            const endDateTime = document.getElementById('endDateTime').value;
            const messageToClient = document.getElementById('messageToClient').value;
            
            // Vérifier les dates
            if (!startDateTime || !endDateTime) {
                showModalAlert(confirmationAlert, 'Veuillez sélectionner les dates de début et de fin', 'warning');
                return;
            }
            
            if (new Date(startDateTime) >= new Date(endDateTime)) {
                showModalAlert(confirmationAlert, 'La date de début doit être antérieure à la date de fin', 'warning');
                return;
            }
            
            try {
                // Ajouter plus de logs
                console.log(`Confirmation de la réservation ${reservationId} avec: début=${startDateTime}, fin=${endDateTime}`);
                
                const response = await fetch(`${API_BASE_URL}/api/agent/reservation/confirm/${reservationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        startDateTime: startDateTime,
                        endDateTime: endDateTime,
                        message: messageToClient
                    }),
                    credentials: 'include'
                });
                
                // Log de la réponse
                console.log('Statut de la réponse:', response.status);
                
                const data = await response.json();
                console.log('Données de réponse:', data);
                
                if (response.ok) {
                    // Fermer le modal
                    confirmationModal.style.display = 'none';
                    
                    // Afficher une notification
                    showAlert('Réservation confirmée avec succès', 'success');
                    
                    // Mettre à jour les listes de réservations
                    await loadAllReservations();
                    
                    // Mettre à jour les statistiques
                    loadAgentStats();
                    
                    // Mettre à jour le calendrier de disponibilité
                    availabilityCalendar.refreshAvailability();
                } else {
                    showModalAlert(confirmationAlert, data.message || 'Erreur lors de la confirmation de la réservation', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors de la confirmation de la réservation:', error);
                showModalAlert(confirmationAlert, 'Erreur de connexion au serveur', 'danger');
            }
        }
        
        // Compléter une réservation
        async function completeReservation() {
            const reservationId = currentReservationId;
            const completionNotes = document.getElementById('completionNotes').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/agent/reservation/complete/${reservationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        notes: completionNotes
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Fermer le modal
                    completeModal.style.display = 'none';
                    
                    // Afficher une notification
                    showAlert('Réservation marquée comme complétée avec succès', 'success');
                    
                    // Mettre à jour les listes de réservations
                    await loadAllReservations();
                    
                    // Mettre à jour les statistiques
                    loadAgentStats();
                    
                    // Mettre à jour le calendrier de disponibilité
                    availabilityCalendar.refreshAvailability();
                } else {
                    showModalAlert(completeAlert, data.message || 'Erreur lors de la complétion de la réservation', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors de la complétion de la réservation:', error);
                showModalAlert(completeAlert, 'Erreur de connexion au serveur', 'danger');
            }
        }
        
        // Annuler une réservation
        async function cancelReservation() {
            const reservationId = currentReservationId;
            const cancellationReason = document.getElementById('cancellationReason').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/agent/reservation/cancel/${reservationId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        reason: cancellationReason
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Fermer le modal
                    cancelModal.style.display = 'none';
                    
                    // Afficher une notification
                    showAlert('Réservation annulée avec succès', 'success');
                    
                    // Mettre à jour les listes de réservations
                    await loadAllReservations();
                    
                    // Mettre à jour les statistiques
                    loadAgentStats();
                    
                    // Mettre à jour le calendrier de disponibilité
                    availabilityCalendar.refreshAvailability();
                } else {
                    showModalAlert(cancelAlert, data.message || 'Erreur lors de l\'annulation de la réservation', 'danger');
                }
            } catch (error) {
                console.error('Erreur lors de l\'annulation de la réservation:', error);
                showModalAlert(cancelAlert, 'Erreur de connexion au serveur', 'danger');
            }
        }
        
        // Gestionnaire de calendrier de disponibilités
        const availabilityCalendar = {
            currentStartDate: null,
            selectedAgencyId: null,
            selectedDateTime: null,
            
            // Initialiser le calendrier
            initialize: function() {
                console.log('Initialisation du calendrier de disponibilité');
                
                if (agencyData && agencyData.agencyId) {
                    this.selectedAgencyId = agencyData.agencyId;
                    console.log(`Agence sélectionnée: ${this.selectedAgencyId}`);
                } else {
                    // Si pas d'agence, utiliser une valeur par défaut
                    this.selectedAgencyId = 1;
                    console.log('Aucune agence trouvée, utilisation de l\'ID 1 par défaut');
                }
                
                this.currentStartDate = this.getStartOfWeek(new Date());
                this.updateWeekLabel();
                this.loadWeekAvailability();
            },
            
            // Obtenir le début de la semaine (lundi) pour une date donnée
            getStartOfWeek: function(date) {
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Ajuster pour dimanche
                return new Date(date.setDate(diff));
            },
            
            // Mettre à jour le libellé de semaine
            updateWeekLabel: function() {
                const endDate = new Date(this.currentStartDate);
                endDate.setDate(endDate.getDate() + 6);
                
                const startFormatted = this.currentStartDate.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'long'
                });
                const endFormatted = endDate.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                
                currentWeekLabel.textContent = `Semaine du ${startFormatted} au ${endFormatted}`;
            },
            
            // Naviguer dans les semaines
            navigateWeek: function(daysToAdd) {
                const newDate = new Date(this.currentStartDate);
                newDate.setDate(newDate.getDate() + daysToAdd);
                this.currentStartDate = this.getStartOfWeek(newDate);
                this.updateWeekLabel();
                this.loadWeekAvailability();
            },
            
            // Formater la date pour l'API (YYYY-MM-DD)
            formatDate: function(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
            
            // Vérifier si une date est aujourd'hui
            isToday: function(date) {
                const today = new Date();
                return date.getDate() === today.getDate() && 
                      date.getMonth() === today.getMonth() && 
                      date.getFullYear() === today.getFullYear();
            },
            
            // Vérifier si une date est dans le passé
            isPastDate: function(date) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return date < today;
            },
            
            // Vérifier si un créneau horaire est passé (pour aujourd'hui)
            isPastTimeSlot: function(timeStr) {
                const [hours, minutes] = timeStr.split(':');
                const slotHour = parseInt(hours);
                const slotMinutes = parseInt(minutes);
                
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();
                
                if (slotHour < currentHour) {
                    return true;
                }
                
                if (slotHour === currentHour && slotMinutes <= currentMinutes) {
                    return true;
                }
                
                return false;
            },
            
            // Charger les disponibilités pour une semaine
            loadWeekAvailability: function() {
                const startDateStr = this.formatDate(this.currentStartDate);
                
                // Montrer un état de chargement
                calendarDays.innerHTML = '<div class="loading">Chargement...</div>';
                calendarSlots.innerHTML = '';
                
                console.log(`Chargement des disponibilités pour la semaine du ${startDateStr}, agence ${this.selectedAgencyId}`);
                
                // Appeler l'API pour obtenir les disponibilités
                fetch(`${API_BASE_URL}/api/availability/${this.selectedAgencyId}/week?startDate=${startDateStr}`, {
                    method: 'GET',
                    credentials: 'include'
                })
                .then(response => {
                    console.log('Statut de réponse:', response.status);
                    if (!response.ok) {
                        throw new Error('Erreur lors du chargement des disponibilités: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Données de disponibilité reçues:', data);
                    this.renderCalendar(data);
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    calendarDays.innerHTML = '<div class="error">Impossible de charger les disponibilités: ' + error.message + '</div>';
                });
            },
            
            // Rafraîchir les disponibilités
            refreshAvailability: function() {
                // Recharger les disponibilités de la semaine actuelle
                this.loadWeekAvailability();
            },
            
            // Afficher le calendrier avec les données de disponibilité
            renderCalendar: function(availabilityData) {
                // Vider les conteneurs
                calendarDays.innerHTML = '';
                calendarSlots.innerHTML = '';
                
                console.log('Rendu du calendrier avec', availabilityData.length, 'jours de données');
                
                // Générer 7 jours à partir de la date de début
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(this.currentStartDate);
                    currentDate.setDate(currentDate.getDate() + i);
                    
                    // Trouver les données de disponibilité pour cette date
                    const dateStr = this.formatDate(currentDate);
                    const dayAvailability = availabilityData.find(day => day.date === dateStr) || {
                        date: dateStr,
                        availableTimeSlots: [],
                        bookedTimeSlots: []
                    };
                    
                    // Créer l'en-tête du jour
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    // Marquer aujourd'hui
                    if (this.isToday(currentDate)) {
                        dayElement.classList.add('today');
                    }
                    
                    // Marquer les jours passés
                    if (this.isPastDate(currentDate)) {
                        dayElement.classList.add('past-date');
                    }
                    
                    const dayName = currentDate.toLocaleDateString('fr-FR', { weekday: 'short' });
                    const dayNumber = currentDate.getDate();
                    
                    dayElement.innerHTML = `
                        <span class="day-name">${dayName}</span>
                        <span class="day-date">${dayNumber}</span>
                    `;
                    calendarDays.appendChild(dayElement);
                    
                    // Créer le conteneur de créneaux pour ce jour
                    const daySlotsElement = document.createElement('div');
                    daySlotsElement.className = 'day-slots';
                    calendarSlots.appendChild(daySlotsElement);
                    
                    // Pour les dates passées, afficher un message
                    if (this.isPastDate(currentDate)) {
                        const pastDateElement = document.createElement('div');
                        pastDateElement.className = 'time-slot past-date-message';
                        pastDateElement.textContent = 'Date passée';
                        daySlotsElement.appendChild(pastDateElement);
                        continue;
                    }
                    
                    // Ajouter les créneaux horaires
                    if (dayAvailability.availableTimeSlots.length === 0 && dayAvailability.bookedTimeSlots.length === 0) {
                        // Pas de créneaux disponibles
                        const noSlotsElement = document.createElement('div');
                        noSlotsElement.className = 'time-slot no-slots';
                        noSlotsElement.textContent = 'Pas de créneaux disponibles';
                        daySlotsElement.appendChild(noSlotsElement);
                    } else {
                        // Combiner et trier tous les créneaux
                        const allSlots = [...new Set([
                            ...dayAvailability.availableTimeSlots,
                            ...dayAvailability.bookedTimeSlots
                        ])].sort();
                        
                        allSlots.forEach(timeStr => {
                            const isAvailable = dayAvailability.availableTimeSlots.includes(timeStr);
                            const isBooked = dayAvailability.bookedTimeSlots.includes(timeStr);
                            
                            // Vérifier si ce créneau est dans le passé (pour aujourd'hui uniquement)
                            const isPastSlot = this.isToday(currentDate) && this.isPastTimeSlot(timeStr);
                            
                            const timeSlotElement = document.createElement('div');
                            timeSlotElement.className = 'time-slot';
                            
                            // Formater l'heure pour l'affichage (ex: "09:00" -> "9h00")
                            const [hours, minutes] = timeStr.split(':');
                            const formattedTime = `${parseInt(hours)}h${minutes}`;
                            
                            if (isPastSlot) {
                                // Créneaux horaires passés
                                timeSlotElement.classList.add('past-slot');
                                timeSlotElement.textContent = `${formattedTime} (passé)`;
                            } else if (isAvailable) {
                                // Créneaux disponibles
                                timeSlotElement.classList.add('available');
                                timeSlotElement.textContent = formattedTime;
                                
                                // Ajouter des attributs de données pour références futures
                                timeSlotElement.dataset.date = dateStr;
                                timeSlotElement.dataset.time = timeStr;
                            } else if (isBooked) {
                                // Créneaux réservés
                                timeSlotElement.classList.add('booked');
                                timeSlotElement.textContent = formattedTime;
                            }
                            
                            daySlotsElement.appendChild(timeSlotElement);
                        });
                    }
                }
            }
        };
    </script>
</body>
</html>
